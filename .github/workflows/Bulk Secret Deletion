name: Bulk Secret Deletion
on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Purge Repository Secrets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }} # PAT Token á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€šá€º
          script: |
            const TARGET_ORG = "GOA-Neural-Swarm";
            const SECRETS_TO_DELETE = ['FIREBASE_KEY', 'GH_TOKEN', 'NEON_KEY', 'SUPABASE_URL', 'SUPABASE_SERVICE_ROLE_KEY'];

            // 1. Org á€‘á€²á€™á€¾á€¬á€›á€¾á€­á€á€²á€· repo á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€›á€¾á€¬á€™á€šá€º
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: TARGET_ORG,
              per_page: 100
            });

            const swarmNodes = repos.filter(repo => repo.name.startsWith('swarm-node-'));
            console.log(`ğŸ§¹ Found ${swarmNodes.length} nodes for deep cleaning...`);

            for (const repo of swarmNodes) {
              console.log(`ğŸ§¼ Cleaning secrets in ${repo.name}...`);
              for (const secretName of SECRETS_TO_DELETE) {
                try {
                  await github.rest.actions.deleteRepoSecret({
                    owner: TARGET_ORG,
                    repo: repo.name,
                    secret_name: secretName
                  });
                  console.log(`   âœ… Deleted: ${secretName}`);
                } catch (err) {
                  // Secret á€™á€›á€¾á€­á€›á€„á€º (á€á€­á€¯á€·) á€–á€»á€€á€ºá€œá€­á€¯á€·á€™á€›á€›á€„á€º á€€á€»á€±á€¬á€ºá€á€½á€¬á€¸á€™á€šá€º
                  console.log(`   â­ï¸ Skipped/Error ${secretName}: ${err.message}`);
                }
              }
            }
            console.log("ğŸ MISSION ACCOMPLISHED: ALL NODES ARE PURIFIED.");
