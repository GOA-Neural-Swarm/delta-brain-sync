name: SOVEREIGN_HYPER_AUTONOMOUS_LOOP

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sovereign_cycle:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Initialize Sovereign Source
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Step 2 - Inject Multi-Engine Dependencies
        run: |
          # á€¡á€“á€­á€€ á€œá€­á€¯á€¡á€•á€ºá€á€²á€· Tools á€á€½á€±á€€á€­á€¯ á€¡á€›á€„á€ºá€á€½á€„á€ºá€¸á€™á€šá€º (á€’á€«á€™á€¾ Error á€™á€á€€á€ºá€™á€¾á€¬)
          python -m pip install --upgrade pip
          pip install kaggle psycopg2-binary requests groq
          # Kaggle command á€€á€­á€¯ path á€‘á€² á€›á€±á€¬á€€á€ºá€¡á€±á€¬á€„á€º á€œá€¯á€•á€ºá€™á€šá€º
          echo "export PATH=$PATH:/home/runner/.local/bin" >> $GITHUB_ENV

      - name: Step 3 - Heavy Task Offload (Kaggle GPU Evolution)
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          # Kaggle á€€á€­á€¯ Push á€™á€šá€º (Kaggle command á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€•á€¼á€®)
          kaggle kernels push -p . || echo "Kaggle Busy"

      - name: Step 4 - Natural Sync Window
        run: |
          echo "Waiting for Kaggle to push evolved brain.py..."
          sleep 45

      - name: Step 5 - Trinity Sync Engine (Memory Ingestion)
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Psycopg2 á€á€½á€„á€ºá€¸á€‘á€¬á€¸á€œá€­á€¯á€· á€¡á€á€¯ Sync_data.py á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€•á€¼á€®
          if [ -f "sync_data.py" ]; then
            python sync_data.py
          elif [ -f "brain.py" ]; then
            python -c "try: from brain import sync_data; sync_data(); except: print('Skipped')"
          fi

      - name: Step 6 - Hyper-Autonomous Self-Coding (Groq AI)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "llama3-70b-8192",
              "messages": [{"role": "user", "content": "The Brain class in main.py expects 784 inputs but data.csv is missing or incompatible. Rewrite main.py to: 1. Use synthetic data generation (numpy) to create 100 samples with 784 features each. 2. Ensure the model trains on this data within the script. 3. Output only the full, clean Python code for main.py without markdown or explanations."}]
            }')

          # Content á€€á€­á€¯ á€†á€½á€²á€‘á€¯á€á€ºá€•á€¼á€®á€¸ Invisible character (U+00A0) á€á€½á€±á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€™á€šá€º
          # sed 's/\xc2\xa0/ /g' á€€ character á€¡á€™á€¾á€¬á€¸á€á€½á€±á€€á€­á€¯ space á€¡á€™á€¾á€”á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€±á€¸á€á€¬á€•á€«
          CONTENT=$(echo $RESPONSE | jq -r '.choices[0].message.content // empty' | sed 's/\xc2\xa0/ /g')

          if [ ${#CONTENT} -gt 20 ]; then
            echo "$CONTENT" > main_evolved.py
            # á€‘á€•á€ºá€†á€„á€·á€º á€á€”á€·á€ºá€…á€„á€ºá€™á€¾á€¯á€¡á€”á€±á€”á€²á€· python á€á€¯á€¶á€¸á€•á€¼á€®á€¸ character á€¡á€™á€¾á€¬á€¸ á€–á€šá€ºá€‘á€¯á€á€ºá€™á€šá€º
            python3 -c "import sys; content = open('main_evolved.py').read(); open('main.py', 'w').write(content.replace('\xa0', ' '))"
            echo "Evolution successful and code cleaned."
          else
            echo "AI output too short. Skipping to prevent empty file."
          fi
        
          
        
          

      - name: Step 7 - Manifest Sovereign State (Final Push)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name 'Sovereign-AI-Bot'
          git config --global user.email 'bot@sovereign.ai'
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add .
          if ! git diff-index --quiet HEAD; then
            git commit -m "ğŸ§¬ [HYPER_EVOLUTION] Full Cycle Manifested: $(date) [skip ci]"
            git push origin main --force
          fi
