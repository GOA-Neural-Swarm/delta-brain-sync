name: SOVEREIGN_HYPER_AUTONOMOUS_LOOP

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sovereign_cycle:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Initialize Sovereign Source
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Step 2 - Inject Multi-Engine Dependencies
        run: |
          # á€¡á€“á€­á€€ á€œá€­á€¯á€¡á€•á€ºá€á€²á€· Tools á€á€½á€±á€€á€­á€¯ á€¡á€›á€„á€ºá€žá€½á€„á€ºá€¸á€™á€šá€º (á€’á€«á€™á€¾ Error á€™á€á€€á€ºá€™á€¾á€¬)
          python -m pip install --upgrade pip
          pip install kaggle psycopg2-binary requests groq
          # Kaggle command á€€á€­á€¯ path á€‘á€² á€›á€±á€¬á€€á€ºá€¡á€±á€¬á€„á€º á€œá€¯á€•á€ºá€™á€šá€º
          echo "export PATH=$PATH:/home/runner/.local/bin" >> $GITHUB_ENV

      - name: Step 3 - Heavy Task Offload (Kaggle GPU Evolution)
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          # Kaggle á€€á€­á€¯ Push á€™á€šá€º (Kaggle command á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€•á€¼á€®)
          kaggle kernels push -p . || echo "Kaggle Busy"

      - name: Step 4 - Natural Sync Window
        run: |
          echo "Waiting for Kaggle to push evolved brain.py..."
          sleep 45

      - name: Step 5 - Trinity Sync Engine (Memory Ingestion)
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Psycopg2 á€žá€½á€„á€ºá€¸á€‘á€¬á€¸á€œá€­á€¯á€· á€¡á€á€¯ Sync_data.py á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€•á€¼á€®
          if [ -f "sync_data.py" ]; then
            python sync_data.py
          elif [ -f "brain.py" ]; then
            python -c "try: from brain import sync_data; sync_data(); except: print('Skipped')"
          fi

      - name: Step 6 - Hyper-Autonomous Self-Coding (Groq AI)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # Groq API á€”á€²á€· main.py/brain.py á€€á€­á€¯ logic á€¡á€†á€„á€·á€ºá€™á€¼á€¾á€„á€·á€ºá€™á€šá€º
          curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "llama3-70b-8192",
              "messages": [{"role": "user", "content": "Analyze existing main.py and brain.py. Based on DB schema, upgrade their logic. Output only full code."}]
            }' | jq -r '.choices[0].message.content' > main_evolved.py
          
          if [ -s main_evolved.py ]; then mv main_evolved.py main.py; fi

      - name: Step 7 - Manifest Sovereign State (Final Push)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name 'Sovereign-AI-Bot'
          git config --global user.email 'bot@sovereign.ai'
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add .
          if ! git diff-index --quiet HEAD; then
            git commit -m "ðŸ§¬ [HYPER_EVOLUTION] Full Cycle Manifested: $(date) [skip ci]"
            git push origin main --force
          fi
