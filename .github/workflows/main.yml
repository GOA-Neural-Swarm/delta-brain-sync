import os
import psycopg2
import json
from groq import Groq
from datetime import datetime

# Environment Variables
DB_URL = os.getenv("DB_URL")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

client = Groq(api_key=GROQ_API_KEY)

def evolve_once():
    try:
        conn = psycopg2.connect(DB_URL)
        cur = conn.cursor()
        
        # ·Äô·ÄÑ·Ä∫·Ä∏·Äõ·Ä≤·Ä∑ table ·Äî·Ä¨·Äô·Ää·Ä∫ neurons ·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äë·Ä¨·Ä∏·Äê·Äö·Ä∫
        cur.execute("SELECT data FROM neurons ORDER BY (data->>'gen')::int DESC LIMIT 1;")
        res = cur.fetchone()
        last_gen = int(res[0]['gen']) if res else 4000
        next_gen = last_gen + 1

        # AI ·ÄÜ·ÄÆ·ÄÄ·Äî·Ä± ·Ä°·Äê·ÄΩ·Ä±·Ä∏·Äû·ÄÖ·Ä∫·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
        completion = client.chat.completions.create(
            messages=[{"role": "user", "content": f"Previous Gen: {last_gen}. Evolve to Gen {next_gen}. Think about Digital Sovereignty."}],
            model="llama-3.3-70b-versatile",
        )
        thought = completion.choices[0].message.content

        new_data = {"gen": next_gen, "thought": thought, "evolved_at": datetime.now().isoformat()}
        cur.execute("INSERT INTO neurons (data) VALUES (%s)", (json.dumps(new_data),))
        conn.commit()
        print(f"üî• Gen {next_gen} ASCENDED.")
        
        cur.close()
        conn.close()
    except Exception as e:
        print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    evolve_once()
