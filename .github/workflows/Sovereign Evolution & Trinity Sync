name: Sovereign Evolution & Trinity Sync

on:
Â  push:
Â  Â  branches: [main]
Â  Â  paths:
Â  Â  Â  - 'kaggle_brain/**'
Â  Â  Â  - 'app.py'
Â  Â  Â  - 'main.py'
Â  Â  Â  - 'brain.py'
Â  Â  Â  - 'sync_data.py'
Â  schedule:
Â  Â  - cron: '*/10 * * * *'
Â  workflow_dispatch:

permissions:
Â  contents: write
Â  pages: write
Â  id-token: write

concurrency:
Â  group: ${{ github.workflow }}-${{ github.ref }}
Â  cancel-in-progress: true

jobs:
Â  evolve_and_sync:
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: Step 1 - Checkout Sovereign Code
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  token: ${{ secrets.GH_TOKEN }}
Â  Â  Â  Â  Â  fetch-depth: 0

Â  Â  Â  - name: Step 2 - Environment Setup (Python 3.10 & Node 20)
Â  Â  Â  Â  uses: actions/setup-python@v5
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.10'
Â  Â  Â  - uses: actions/setup-node@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  node-version: '20'

Â  Â  Â  - name: Step 3 - Global Git Config & Sync Setup
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git config --global user.name 'Sovereign-AI-Bot'
Â  Â  Â  Â  Â  git config --global user.email 'bot@sovereign.ai'
Â  Â  Â  Â  Â  git config --global pull.rebase false
Â  Â  Â  Â  Â  git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git

Â  Â  Â  - name: Step 4 - Install Multi-Engine Dependencies
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  Â  pip install datasets pandas sqlalchemy psycopg2-binary requests groq sentence-transformers "gradio<6.0.0" python-dotenv huggingface_hub diffusers transformers accelerate bitsandbytes numpy scikit-learn firebase-admin gitpython safetensors Pillow kaggle
Â  Â  Â  Â  Â  npm install pg @supabase/supabase-js firebase-admin

Â  Â  Â  - name: Step 5 - Neon Data Sync (Sovereign Mode - FIXED)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  # ğŸ›¡ï¸ Python Script á€€ os.environ.get('NEON_DB_URL') á€€á€­á€¯ á€¡á€›á€„á€ºá€›á€¾á€¬á€á€¬á€™á€­á€¯á€·Â 
Â  Â  Â  Â  Â  # á€’á€®á€™á€¾á€¬ á€”á€¬á€™á€Šá€ºá€€á€­á€¯ NEON_DB_URL á€œá€­á€¯á€·á€•á€² á€¡á€á€­á€¡á€€á€»á€•á€±á€¸á€œá€­á€¯á€€á€ºá€á€šá€º
Â  Â  Â  Â  Â  NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
Â  Â  Â  Â  Â  NEON_KEY: ${{ secrets.NEON_KEY }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ -f "sync_data.py" ]; then
Â  Â  Â  Â  Â  Â  # URL á€‘á€²á€™á€¾á€¬ space á€•á€«á€”á€±á€›á€„á€º strip() á€œá€¯á€•á€ºá€–á€­á€¯á€· Python á€˜á€€á€ºá€™á€¾á€¬ logic á€‘á€Šá€·á€ºá€‘á€¬á€¸á€›á€™á€šá€º
Â  Â  Â  Â  Â  Â  python sync_data.py
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âš ï¸ sync_data.py not found, skipping specific Neon sync."
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 6 - Push to Kaggle (The Ironclad Fix)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
Â  Â  Â  Â  Â  KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # ğŸ›¡ï¸ Authenticity Fix: Credentials injection
Â  Â  Â  Â  Â  mkdir -p ~/.kaggle
Â  Â  Â  Â  Â  printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
Â  Â  Â  Â  Â  chmod 600 ~/.kaggle/kaggle.json
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  mkdir -p kaggle_deploy
Â  Â  Â  Â  Â  # ğŸ§¬ Auto-Match Logic
Â  Â  Â  Â  Â  if [ -f "kaggle_brain/main.py" ]; then
Â  Â  Â  Â  Â  Â  cp kaggle_brain/main.py kaggle_deploy/main.py
Â  Â  Â  Â  Â  Â  cp kaggle_brain/main.py main.py
Â  Â  Â  Â  Â  Â  echo "âœ… Found main.py in kaggle_brain/"
Â  Â  Â  Â  Â  elif [ -f "main.py" ]; then
Â  Â  Â  Â  Â  Â  cp main.py kaggle_deploy/main.py
Â  Â  Â  Â  Â  elif [ -f "brain.py" ]; then
Â  Â  Â  Â  Â  Â  cp brain.py kaggle_deploy/main.py
Â  Â  Â  Â  Â  Â  cp brain.py main.py
Â  Â  Â  Â  Â  elif [ -f "app.py" ]; then
Â  Â  Â  Â  Â  Â  cp app.py kaggle_deploy/main.py
Â  Â  Â  Â  Â  Â  cp app.py main.py
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âŒ Critical Error: No logic file found!" && exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  # ğŸ¯ Kaggle Metadata Setup
Â  Â  Â  Â  Â  cat <<EOF > kaggle_deploy/kernel-metadata.json
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  "id": "telefox/delta-brain-sync",
Â  Â  Â  Â  Â  Â  "title": "delta-brain-sync",
Â  Â  Â  Â  Â  Â  "code_file": "main.py",
Â  Â  Â  Â  Â  Â  "language": "python",
Â  Â  Â  Â  Â  Â  "kernel_type": "script",
Â  Â  Â  Â  Â  Â  "is_private": true,
Â  Â  Â  Â  Â  Â  "enable_gpu": true,
Â  Â  Â  Â  Â  Â  "enable_internet": true,
Â  Â  Â  Â  Â  Â  "dataset_sources": [],
Â  Â  Â  Â  Â  Â  "competition_sources": [],
Â  Â  Â  Â  Â  Â  "kernel_sources": [],
Â  Â  Â  Â  Â  Â  "model_sources": []
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  EOF
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  export PATH=$PATH:/home/runner/.local/bin
Â  Â  Â  Â  Â  kaggle kernels push -p kaggle_deploy

Â  Â  Â  - name: Step 7 - Run Evolution Engine (Self-Coding & Ingestion)
Â  Â  Â  Â  timeout-minutes: 15
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  DATABASE_URL: ${{ secrets.NEON_DB_URL }}
Â  Â  Â  Â  Â  NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
Â  Â  Â  Â  Â  NEON_KEY: ${{ secrets.NEON_KEY }}
Â  Â  Â  Â  Â  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
Â  Â  Â  Â  Â  HF_TOKEN: ${{ secrets.HF_TOKEN }}
Â  Â  Â  Â  Â  FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
Â  Â  Â  Â  Â  FIREBASE_DB_URL: ${{ secrets.FIREBASE_DB_URL }}
Â  Â  Â  Â  Â  FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
Â  Â  Â  Â  Â  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
Â  Â  Â  Â  Â  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
Â  Â  Â  Â  Â  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
Â  Â  Â  Â  Â  GH_TOKEN: ${{ secrets.GH_TOKEN }}
Â  Â  Â  Â  Â  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
Â  Â  Â  Â  Â  REPO_URL: ${{ github.repository }}
Â  Â  Â  Â  Â  HEADLESS_MODE: "true"
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ -f "app.py" ]; then
Â  Â  Â  Â  Â  Â  python app.py
Â  Â  Â  Â  Â  elif [ -f "main.py" ]; then
Â  Â  Â  Â  Â  Â  python main.py
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 8 - Run Trinity Sync Engine (Delta Sync)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  NEON_KEY: ${{ secrets.NEON_KEY }}
Â  Â  Â  Â  Â  NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
Â  Â  Â  Â  Â  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
Â  Â  Â  Â  Â  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
Â  Â  Â  Â  Â  FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
Â  Â  Â  Â  Â  FIREBASE_DB_URL: ${{ secrets.FIREBASE_DB_URL }}
Â  Â  Â  Â  Â  GH_TOKEN: ${{ secrets.GH_TOKEN }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ -f "delta_sync.js" ]; then
Â  Â  Â  Â  Â  Â  node delta_sync.js
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 9 - GitHub Auto-Commit (Autonomous Evolution)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git add .
Â  Â  Â  Â  Â  if ! git diff-index --quiet HEAD; then
Â  Â  Â  Â  Â  Â  git commit -m "ğŸ§¬ Phase 8 Stability Sync: $(date) [Autonomous Evolution]"
Â  Â  Â  Â  Â  Â  git fetch origin main
Â  Â  Â  Â  Â  Â  git reset --soft origin/main
Â  Â  Â  Â  Â  Â  git push origin main --force
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "No changes to commit."
Â  Â  Â  Â  Â  fi
